#!/bin/bash
# Pomodoro timer for i3blocks
# Usage: pomodoro set 25m | pomodoro stop | pomodoro (show status)

TIMER_FILE="/tmp/pomodoro_timer"

case "$1" in
    set)
        # Parse time (e.g., 10m, 25m, 1h, 90s)
        TIME_STR="$2"
        if [[ -z "$TIME_STR" ]]; then
            notify-send "Pomodoro" "Usage: pomodoro set 10m" -t 3000
            exit 1
        fi

        # Convert to seconds
        if [[ "$TIME_STR" =~ ^([0-9]+)m$ ]]; then
            SECONDS_TOTAL=$((${BASH_REMATCH[1]} * 60))
        elif [[ "$TIME_STR" =~ ^([0-9]+)h$ ]]; then
            SECONDS_TOTAL=$((${BASH_REMATCH[1]} * 3600))
        elif [[ "$TIME_STR" =~ ^([0-9]+)s$ ]]; then
            SECONDS_TOTAL=${BASH_REMATCH[1]}
        elif [[ "$TIME_STR" =~ ^([0-9]+)$ ]]; then
            # Default to minutes if no suffix
            SECONDS_TOTAL=$(($TIME_STR * 60))
        else
            notify-send "Pomodoro" "Invalid format. Use: 10m, 1h, 90s" -t 3000
            exit 1
        fi

        END_TIME=$(($(date +%s) + SECONDS_TOTAL))
        echo "$END_TIME" > "$TIMER_FILE"
        notify-send "Pomodoro" "Timer set for $TIME_STR" -t 2000
        pkill -RTMIN+12 i3blocks
        exit 0
        ;;
    stop)
        rm -f "$TIMER_FILE"
        notify-send "Pomodoro" "Timer stopped" -t 2000
        pkill -RTMIN+12 i3blocks
        exit 0
        ;;
    add)
        # Add time to existing timer
        TIME_STR="$2"
        if [[ -f "$TIMER_FILE" ]]; then
            END_TIME=$(cat "$TIMER_FILE")
            if [[ "$TIME_STR" =~ ^([0-9]+)m$ ]]; then
                SECONDS_ADD=$((${BASH_REMATCH[1]} * 60))
            elif [[ "$TIME_STR" =~ ^([0-9]+)$ ]]; then
                SECONDS_ADD=$(($TIME_STR * 60))
            else
                SECONDS_ADD=300
            fi
            NEW_END=$((END_TIME + SECONDS_ADD))
            echo "$NEW_END" > "$TIMER_FILE"
            notify-send "Pomodoro" "Added $TIME_STR" -t 2000
            pkill -RTMIN+12 i3blocks
        fi
        exit 0
        ;;
esac

# Default: show status (called by i3blocks)
if [[ ! -f "$TIMER_FILE" ]]; then
    echo ""
    exit 0
fi

END_TIME=$(cat "$TIMER_FILE")
NOW=$(date +%s)
REMAINING=$((END_TIME - NOW))

if [[ $REMAINING -le 0 ]]; then
    # Timer finished
    rm -f "$TIMER_FILE"
    notify-send -u critical "Pomodoro" "⏰ Time's up!" -t 10000
    paplay /usr/share/sounds/freedesktop/stereo/complete.oga 2>/dev/null &
    echo ""
    exit 0
fi

# Format remaining time
MINS=$((REMAINING / 60))
SECS=$((REMAINING % 60))

# Full text
printf "⏱ %02d:%02d\n" $MINS $SECS
# Short text
printf "%02d:%02d\n" $MINS $SECS

# Color based on time remaining
if [[ $REMAINING -le 60 ]]; then
    echo "#ff5555"  # Red - less than 1 min
elif [[ $REMAINING -le 300 ]]; then
    echo "#f1fa8c"  # Yellow - less than 5 min
fi
